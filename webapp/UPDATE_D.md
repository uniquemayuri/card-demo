VERSION UPDATE — D 类卡与颜色/奖励更新（2025-12-26）

本次更新内容（与之前 BALANCE.md 不同，聚焦 D 类与颜色机制）：

1) 奖励选择数量
- 通关奖励选择从 4 张改为 3 张（减少选择扩散，增加决策权重）。

2) 方块颜色与分配
- 下落方块统一为 4 种颜色：红 / 绿 / 蓝 / 橙（对应内部索引 0,1,2,3）。
- 颜色与形状不再绑定：方块形状（I/O/T/J/L/S/Z）和颜色独立随机分配。
- 颜色抽样采用权重机制：初始权重均为 100（红/绿/蓝/橙）。获得 D 类卡会增加对应颜色的权重（每张 +10）。最终出现概率按权重比例计算。
- 颜色编码在 arena 中为复合值： (colorIndex+1)*10 + shapeId，例如红色的 Z 形可能为 11..17 中的某个值，绘制时根据复合值解析颜色。

3) D 类卡牌（新）
- D1：增加蓝色出现权重 +10%。每次消除时，每个蓝色方块额外 +20 分（可叠加，若拥有多张 D1 则按张数累加）。
- D2：增加红色出现权重 +10%。每次方块下落完成后若该下落方块为红色，则 +100 分（可叠加，按 D2 张数乘算）。
- D3：增加绿色出现权重 +10%。当下落方块连续为绿色（从第二次起），每次触发 +50 分（可叠加，按 D3 张数乘算）。
- D4：增加橙色出现权重 +10%。如果橙色的权重严格为四色中最大，则橙色方块在触发得分效果时可视为红/绿/蓝任意一种以触发对应的 D1/D2/D3 的得分（仅在触发得分时作为别色计数，不改变概率分配）。

4) 实现要点
- 颜色抽样通过 `colorWeights` 数组（初始 [100,100,100,100]）进行随机选择；获得 D 类卡时会对权重做 `+=10` 操作，堆叠生效。
- 活动/预览方块分别持有 `player.currentColor` 与 `nextColor`，绘制与合并时使用颜色覆盖或写入 arena 复合值。
- 在消行判定处会保留被消除行的颜色数据以统计蓝色方块数并应用 D1 奖励；在着陆判定处会触发 D2/D3 的即时奖励。

5) 与现有系统的交互
- D 类卡为可叠加效果（权重与奖励均按卡数累加）。
- D4 的“作为其他颜色触发得分”仅影响触发得分的判定（例如，橙色在橙色权重最大时可被计为蓝色以触发 D1 的蓝色每块加分），但 D4 本身仍增加橙色权重。

6) 文件变更
- `webapp/tetris.js`：实现颜色/抽样、奖励选择数改为 3、D 类卡牌的机制、绘制/合并/消行的颜色处理逻辑。
- `webapp/UPDATE_D.md`：本说明文件。

7) 测试建议
- 在本地启动静态服务器并在浏览器试玩，重点验证：
  - 下落方块颜色是否随机且与形状无关（可在多次下落中观察颜色-形状组合是否多样）。
  - 获得 D1/D2/D3/D4 后对应颜色出现率是否明显上升（可通过多次游戏统计或短期观察）。
  - D1 每个蓝色被消除时是否按张数获得额外分数；D2 在红色落地时触发分数；D3 连续绿色落地是否从第二次起触发分数；D4 在橙色为最大权重时作为通配触发其他 D 的效果。

---
如需我将 `UPDATE_D.md` 合并进 `BALANCE.md`、或增加代码参考行号与示例截图/播放记录，我可以继续执行。